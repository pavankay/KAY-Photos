<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kay Photos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #121212;
            color: #f5f5f5;
            line-height: 1.6;
        }
        
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
        }
        
        .wrapper {
            width: 200px;
            height: 60px;
            position: relative;
            z-index: 1;
        }
        
        .circle {
            width: 20px;
            height: 20px;
            position: absolute;
            border-radius: 50%;
            background-color: #fff;
            left: 15%;
            transform-origin: 50%;
            animation: circle7124 .5s alternate infinite ease;
        }
        
        @keyframes circle7124 {
            0% {
                top: 60px;
                height: 5px;
                border-radius: 50px 50px 25px 25px;
                transform: scaleX(1.7);
            }
            40% {
                height: 20px;
                border-radius: 50%;
                transform: scaleX(1);
            }
            100% {
                top: 0%;
            }
        }
        
        .circle:nth-child(2) {
            left: 45%;
            animation-delay: .2s;
        }
        
        .circle:nth-child(3) {
            left: auto;
            right: 15%;
            animation-delay: .3s;
        }
        
        .shadow {
            width: 20px;
            height: 4px;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.9);
            position: absolute;
            top: 62px;
            transform-origin: 50%;
            z-index: -1;
            left: 15%;
            filter: blur(1px);
            animation: shadow046 .5s alternate infinite ease;
        }
        
        @keyframes shadow046 {
            0% {
                transform: scaleX(1.5);
            }
            40% {
                transform: scaleX(1);
                opacity: .7;
            }
            100% {
                transform: scaleX(.2);
                opacity: .4;
            }
        }
        
        .shadow:nth-child(4) {
            left: 45%;
            animation-delay: .2s
        }
        
        .shadow:nth-child(5) {
            left: auto;
            right: 15%;
            animation-delay: .3s;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            opacity: 0;
            transition: opacity 1s ease-in;
        }
        
        header {
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 40px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 2px;
        }
        
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-links {
            display: flex;
            gap: 30px;
        }
        
        .nav-links a {
            color: #f5f5f5;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .nav-links a:hover {
            color: #e0e0e0;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .gallery-item {
            position: relative;
            overflow: hidden;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease, transform 0.8s ease;
            min-height: 200px;
            background-color: #1e1e1e;
            grid-column: span 4; /* Default span 4 columns (1/3 of grid) */
        }
        
        .gallery-item.wide {
            grid-column: span 6; /* 1/2 of grid width */
        }
        
        .gallery-item.tall {
            grid-row: span 2;
            min-height: 420px;
        }
        
        .gallery-item.large {
            grid-column: span 8; /* 2/3 of grid width */
            grid-row: span 2;
            min-height: 420px;
        }
        
        .gallery-item.extra-wide {
            grid-column: span 12; /* Full width */
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
            will-change: transform;
            backface-visibility: hidden;
            transform: translateZ(0);
        }
        
        .gallery-item:hover img {
            transform: scale(1.05);
        }
        
        .gallery-item-info {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: #fff;
            transform: translateY(100%);
            transition: transform 0.4s ease;
        }
        
        .gallery-item:hover .gallery-item-info {
            transform: translateY(0);
            opacity: 1;
        }
        
        .about-section {
            display: flex;
            gap: 40px;
            margin: 60px 0;
            align-items: center;
            flex-direction: row;
        }
        
        .about-image {
            flex: 0 0 300px;
            border-radius: 4px;
            overflow: hidden;
            height: 300px;
        }
        
        .about-image img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }
        
        .about-content {
            flex: 1;
            padding-left: 20px;
        }
        
        .about-content h2 {
            margin-bottom: 20px;
            font-size: 32px;
        }
        
        .categories {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }
        
        .category-btn {
            background-color: transparent;
            color: #f5f5f5;
            border: none;
            padding: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .category-btn::after {
            content: '';
            position: absolute;
            bottom: -21px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #f5f5f5;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .category-btn:hover::after,
        .category-btn.active::after {
            transform: scaleX(1);
        }
        
        .category-btn:hover,
        .category-btn.active {
            background-color: transparent;
            color: #f5f5f5;
        }
        
        .section-title, .about-content h2 {
            font-size: 28px;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
            position: relative;
            padding-bottom: 15px;
        }
        
        .section-title::after, .about-content h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background-color: #f5f5f5;
        }
        
        .about-content h2 {
            text-align: left;
        }
        
        .about-content h2::after {
            left: 0;
            transform: none;
        }
        
        .gallery-section {
            padding-top: 20px;
            margin-bottom: 60px;
        }
        
        .hidden {
            display: none;
        }
        
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .lightbox-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }
        
        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            display: block;
        }
        
        .close-lightbox {
            position: absolute;
            top: -40px;
            right: 0;
            color: #fff;
            font-size: 30px;
            cursor: pointer;
        }
        
        footer {
            border-top: 1px solid #333;
            padding: 20px 0;
            text-align: center;
            margin-top: 60px;
        }
        
        /* Loading placeholder */
        .image-placeholder {
            background: linear-gradient(90deg, #1e1e1e 0%, #2a2a2a 50%, #1e1e1e 100%);
            background-size: 200% 100%;
            animation: loadingPlaceholder 1.5s infinite;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        @keyframes loadingPlaceholder {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        @media (max-width: 1200px) {
            .gallery {
                grid-template-columns: repeat(9, 1fr);
            }
            
            .gallery-item {
                grid-column: span 3; /* 1/3 of 9 columns */
            }
            
            .gallery-item.wide {
                grid-column: span 6; /* 2/3 of grid width */
            }
            
            .gallery-item.large,
            .gallery-item.extra-wide {
                grid-column: span 9; /* Full width on medium screens */
            }
        }
        
        @media (max-width: 768px) {
            .gallery {
                grid-template-columns: repeat(6, 1fr);
                gap: 10px;
            }
            
            .gallery-item {
                grid-column: span 3; /* 1/2 of 6 columns */
            }
            
            .gallery-item.wide,
            .gallery-item.large {
                grid-column: span 6; /* Full width on tablet */
            }
            
            .gallery-item.extra-wide {
                grid-column: span 6; /* Full width */
            }
            
            .about-section {
                flex-direction: column;
            }
            
            .about-content {
                padding-left: 0;
            }
        }
        
        @media (max-width: 480px) {
            .gallery {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .gallery-item,
            .gallery-item.wide,
            .gallery-item.tall,
            .gallery-item.large,
            .gallery-item.extra-wide {
                grid-column: span 2; /* Full width on mobile */
                grid-row: auto;
                min-height: 180px;
            }
            
            .gallery-item.tall {
                min-height: 300px;
            }
        }
            
        .nav-links {
            gap: 15px;
        }
        
        @media (max-width: 480px) {
            .logo {
                font-size: 24px;
            }
            
            nav {
                flex-direction: column;
                gap: 20px;
            }
        }
        
        .section-divider {
            border-top: 1px solid #333;
            margin: 60px 0;
            width: 100%;
        }
        
        .gallery-section {
            transition: opacity 0.3s ease;
            opacity: 1;
        }
        
        .gallery-section.hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        
        #gallery {
            position: relative;
            min-height: 400px;
        }
        
        .gallery-item {
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
    </style>
</head>
<body>
    <div class="loader-container">
        <div class="wrapper">
            <div class="circle"></div>
            <div class="circle"></div>
            <div class="circle"></div>
            <div class="shadow"></div>
            <div class="shadow"></div>
            <div class="shadow"></div>
        </div>
    </div>
    
    <div class="container">
        <header>
            <nav>
                <div class="logo">KAY PHOTOS</div>
                <div class="nav-links">
                    <a href="#gallery">Gallery</a>
                    <a href="#about">About</a>
                </div>
            </nav>
        </header>
        
        <main>
            <section id="gallery">
                <h2 class="section-title">Photo Gallery</h2>
                
                <div class="categories" id="category-buttons">
                    <button class="category-btn active" data-category="all">All Photos</button>
                </div>
                
                <section id="all" class="gallery-section">
                    <div class="gallery" id="all-gallery"></div>
                </section>
            </section>
            
            <div class="section-divider"></div>
            
            <section id="about" class="about-section">
                <div class="about-image">
                    <img src="photos/image_files/ME.jpg" alt="Photographer Profile">
                </div>
                <div class="about-content">
                    <h2>About the Photographer</h2>
                    <p>I am arjun, I like life</p>
                </div>
            </section>
        </main>
        
        <footer>
            <p>Kay Photos</p>
        </footer>
    </div>
    
    <div class="lightbox">
        <div class="lightbox-content">
            <span class="close-lightbox">×</span>
            <img src="" alt="Lightbox image">
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loader = document.querySelector('.loader-container');
            const container = document.querySelector('.container');
            const lightbox = document.querySelector('.lightbox');
            const lightboxImg = lightbox.querySelector('img');
            const closeLightbox = document.querySelector('.close-lightbox');
            const categoryButtonsContainer = document.getElementById('category-buttons');
            const galleryContainer = document.getElementById('gallery');
            
            const createdSections = new Set(['all']);
            const sectionGalleries = {
                'all': document.getElementById('all-gallery')
            };
            
            // Image cache to prevent reloading
            const imageCache = new Map();
            
            const showSiteContent = () => {
                container.style.opacity = '1';
                setTimeout(() => {
                    loader.style.opacity = '0';
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 500);
                }, 500);
            };
            
            const setupLightbox = () => {
                const galleryItems = document.querySelectorAll('.gallery-item');
                galleryItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const thumbImg = this.querySelector('img');
                        
                        // Get the original full-size URL (either from data-original-src or data-full-size)
                        const fullSizeUrl = thumbImg.dataset.originalSrc || thumbImg.dataset.fullSize || thumbImg.src;
                        
                        // Show loading state in lightbox
                        lightbox.style.display = 'flex';
                        lightboxImg.src = thumbImg.src; // Initially show thumbnail
                        
                        // Load the full-size image only when lightbox is opened
                        if (fullSizeUrl) {
                            // Add a loading indicator
                            const loadingText = document.createElement('div');
                            loadingText.textContent = 'Loading high resolution image...';
                            loadingText.style.color = 'white';
                            loadingText.style.position = 'absolute';
                            loadingText.style.bottom = '10px';
                            loadingText.style.left = '0';
                            loadingText.style.right = '0';
                            loadingText.style.textAlign = 'center';
                            lightbox.querySelector('.lightbox-content').appendChild(loadingText);
                            
                            // Check if we have it cached already
                            if (imageCache.has(fullSizeUrl)) {
                                lightboxImg.src = imageCache.get(fullSizeUrl);
                                loadingText.remove();
                            } else {
                                // Preload the full-size image
                                const fullImg = new Image();
                                fullImg.onload = function() {
                                    lightboxImg.src = fullSizeUrl;
                                    imageCache.set(fullSizeUrl, fullSizeUrl);
                                    loadingText.remove();
                                };
                                fullImg.onerror = function() {
                                    loadingText.textContent = 'Could not load high resolution image';
                                    setTimeout(() => {
                                        loadingText.remove();
                                    }, 2000);
                                };
                                fullImg.src = fullSizeUrl;
                            }
                        }
                    });
                });
            };
            
            closeLightbox.addEventListener('click', function() {
                lightbox.style.display = 'none';
            });
            
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    lightbox.style.display = 'none';
                }
            });
            
            // Thumbnail cache to prevent regenerating thumbnails
            const thumbnailCache = new Map();
            
            // Function that actually creates thumbnails on the client side
            const createThumbnail = (originalSrc, targetWidth = 500) => {
                // Check if we already have this thumbnail cached
                if (thumbnailCache.has(originalSrc)) {
                    return thumbnailCache.get(originalSrc);
                }
                
                // Return a promise that resolves with the thumbnail URL
                return new Promise((resolve, reject) => {
                    // Create a new image to load the original
                    const img = new Image();
                    
                    // Set up load handler
                    img.onload = function() {
                        // Get original dimensions
                        const width = this.naturalWidth;
                        const height = this.naturalHeight;
                        
                        // If image is already small enough, just use it
                        if (width <= targetWidth) {
                            thumbnailCache.set(originalSrc, originalSrc);
                            resolve(originalSrc);
                            return;
                        }
                        
                        // Calculate new height maintaining aspect ratio
                        const aspectRatio = width / height;
                        const newHeight = Math.round(targetWidth / aspectRatio);
                        
                        // Create canvas for resizing
                        const canvas = document.createElement('canvas');
                        canvas.width = targetWidth;
                        canvas.height = newHeight;
                        
                        // Draw image at new size
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, targetWidth, newHeight);
                        
                        // Get the resized image as a data URL (thumbnail)
                        try {
                            // Lower quality for thumbnails (0.6-0.8 is usually good)
                            const thumbnailUrl = canvas.toDataURL('image/jpeg', 0.7);
                            
                            // Cache and return the thumbnail URL
                            thumbnailCache.set(originalSrc, thumbnailUrl);
                            resolve(thumbnailUrl);
                        } catch (e) {
                            // If we can't create a thumbnail (e.g., CORS issues), use original
                            console.warn('Could not create thumbnail:', e);
                            thumbnailCache.set(originalSrc, originalSrc);
                            resolve(originalSrc);
                        }
                    };
                    
                    // Handle errors
                    img.onerror = function() {
                        console.error('Failed to load image for thumbnail creation:', originalSrc);
                        resolve(originalSrc); // Fall back to original
                    };
                    
                    // Set crossOrigin to anonymous to avoid tainted canvas issues if needed
                    img.crossOrigin = 'anonymous';
                    img.src = originalSrc;
                });
            };
            
            // Function to generate a thumbnail URL from a full-size image path
            const generateThumbnailUrl = (imagePath) => {
                // For gallery view - return the original path
                // We'll create the actual thumbnail when the image loads
                return imagePath;
            };
            
            // Create a gallery item with thumbnail and full-size image reference
            const createGalleryItem = (imagePath, title) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.style.opacity = '0';
                item.style.transform = 'translateY(20px)';
                
                // Create placeholder while image loads
                const placeholder = document.createElement('div');
                placeholder.className = 'image-placeholder';
                item.appendChild(placeholder);
                
                const img = document.createElement('img');
                
                // Use thumbnail URL for gallery view (this would be generated server-side)
                const thumbnailUrl = generateThumbnailUrl(imagePath);
                img.src = thumbnailUrl;
                img.alt = title;
                img.loading = 'lazy';
                img.decoding = 'async';
                
                // Store full-size image path for lightbox
                img.dataset.fullSize = imagePath;
                
                // Remove placeholder when thumbnail loads
                img.onload = function() {
                    placeholder.style.display = 'none';
                    
                    // Generate an actual thumbnail for this image
                    createThumbnail(this.src).then(thumbnailUrl => {
                        // Only update the src if we got a different URL (an actual thumbnail)
                        if (thumbnailUrl !== this.src) {
                            // Store the original URL for the lightbox
                            this.dataset.originalSrc = this.src;
                            // Switch to the thumbnail
                            this.src = thumbnailUrl;
                        }
                    }).catch(err => {
                        console.warn('Failed to create thumbnail:', err);
                    });
                    
                    // Determine image size class after load
                    const setImageClass = () => {
                        // Create a temporary image to get natural dimensions
                        const tempImg = new Image();
                        tempImg.onload = function() {
                            const ratio = this.width / this.height;
                            const width = this.width;
                            const height = this.height;
                            
                            // More sophisticated classification based on aspect ratio and size
                            if (ratio >= 2.0) {
                                // Extra wide panorama
                                item.classList.add('extra-wide');
                            } else if (ratio >= 1.7 && ratio < 2.0) {
                                // Wide format
                                item.classList.add('wide');
                            } else if (ratio <= 0.6) {
                                // Very tall format
                                item.classList.add('tall');
                            } else if (ratio > 1.3 && ratio < 1.7 && width > 1200) {
                                // Large landscape format with significant width
                                item.classList.add('large');
                            } else if (ratio >= 0.6 && ratio <= 0.7 && height > 1200) {
                                // Large portrait format with significant height
                                item.classList.add('large');
                            } else if (width > 2000 || height > 2000) {
                                // Any very large image regardless of ratio
                                item.classList.add('large');
                            }
                            
                            // Store aspect ratio as data attribute for potential JS layout adjustments
                            item.dataset.ratio = ratio.toFixed(2);
                            item.dataset.width = width;
                            item.dataset.height = height;
                        };
                        tempImg.src = thumbnailUrl;
                    };
                    
                    setImageClass();
                };
                
                // Handle error if thumbnail fails to load
                img.onerror = function() {
                    placeholder.textContent = title;
                    placeholder.style.display = 'flex';
                    placeholder.style.justifyContent = 'center';
                    placeholder.style.alignItems = 'center';
                    placeholder.style.color = '#fff';
                    placeholder.style.padding = '10px';
                    placeholder.style.textAlign = 'center';
                };
                
                const info = document.createElement('div');
                info.className = 'gallery-item-info';
                
                const h3 = document.createElement('h3');
                h3.textContent = title;
                
                info.appendChild(h3);
                item.appendChild(img);
                item.appendChild(info);
                
                return item;
            };
            
            // Improved gallery layout manager
            const createMasonryLayout = (gallery) => {
                if (!gallery) return;
                
                // Get all gallery items
                const items = Array.from(gallery.querySelectorAll('.gallery-item'));
                
                // Reset any inline styles that might affect layout
                items.forEach(item => {
                    if (item.dataset.positioned) return;
                    
                    // Make sure item is visible before calculating
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                    item.dataset.positioned = 'true';
                });
            };
            
            const addGalleryItemWithAnimation = (item, index, galleryElement) => {
                return new Promise((resolve) => {
                    galleryElement.appendChild(item);
                    item.offsetHeight; // Force reflow
                    
                    // Shorter delay for better performance
                    setTimeout(() => {
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                        
                        // Apply masonry layout after items are added
                        createMasonryLayout(galleryElement);
                        
                        setTimeout(resolve, 50);
                    }, Math.min(index * 30, 300)); // Cap the maximum delay
                });
            };
            
            const createSectionIfNeeded = (sectionId, displayName) => {
                if (createdSections.has(sectionId)) {
                    return;
                }
                
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.setAttribute('data-category', sectionId);
                button.textContent = displayName || sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
                categoryButtonsContainer.appendChild(button);
                
                const section = document.createElement('section');
                section.id = sectionId;
                section.className = 'gallery-section hidden';
                
                const gallery = document.createElement('div');
                gallery.className = 'gallery';
                gallery.id = `${sectionId}-gallery`;
                
                section.appendChild(gallery);
                galleryContainer.appendChild(section);
                
                createdSections.add(sectionId);
                sectionGalleries[sectionId] = gallery;
                
                button.addEventListener('click', handleCategoryClick);
            };
            
            const handleCategoryClick = function() {
                document.querySelectorAll('.category-btn').forEach(btn => 
                    btn.classList.remove('active')
                );
                
                this.classList.add('active');
                
                const sectionId = this.getAttribute('data-category');
                
                document.querySelectorAll('.gallery-section').forEach(section => {
                    if (section.id === sectionId) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });
                
                // Preload visible images in this section
                preloadVisibleImages(document.getElementById(`${sectionId}-gallery`));
            };
            
            // Preload images currently visible in the viewport
            const preloadVisibleImages = (galleryElement) => {
                if (!galleryElement) return;
                
                const items = galleryElement.querySelectorAll('.gallery-item');
                items.forEach(item => {
                    const img = item.querySelector('img');
                    if (img && !img.complete) {
                        img.src = img.src; // Reload if not already loaded
                    }
                });
            };
            
            document.querySelector('.category-btn[data-category="all"]')
                .addEventListener('click', handleCategoryClick);
            
            const formatSectionId = (section) => {
                return section.toLowerCase()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/\s+/g, '-');
            };
            
            // Implement Intersection Observer for better lazy loading
            const setupIntersectionObserver = () => {
                if ('IntersectionObserver' in window) {
                    const options = {
                        root: null, // viewport
                        rootMargin: '200px', // Load images 200px before they appear
                        threshold: 0.1 // Trigger when 10% of the element is visible
                    };
                    
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target.querySelector('img');
                                if (img && img.dataset.src) {
                                    img.src = img.dataset.src;
                                    img.removeAttribute('data-src');
                                }
                                observer.unobserve(entry.target);
                            }
                        });
                    }, options);
                    
                    // Observe all gallery items
                    document.querySelectorAll('.gallery-item').forEach(item => {
                        observer.observe(item);
                    });
                    
                    return observer;
                }
                return null;
            };
            
            const loadPhotosFromJSON = async () => {
                try {
                    const response = await fetch('photos/photos.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    document.getElementById('all-gallery').innerHTML = '';
                    
                    const sectionsMap = new Map();
                    data.forEach(photo => {
                        if (photo.section && !sectionsMap.has(photo.section)) {
                            const sectionId = formatSectionId(photo.section);
                            sectionsMap.set(sectionId, photo.section);
                        }
                    });
                    
                    sectionsMap.forEach((displayName, sectionId) => {
                        createSectionIfNeeded(sectionId, displayName);
                    });
                    
                    // Improved image loading and layout strategy
                    
                    // First, preprocess the data to optimize layout
                    const optimizeImageLayout = (images) => {
                        // Sort images by rough aspect ratio categories for better layout
                        return [...images].sort((a, b) => {
                            const aData = a.metadata || {};
                            const bData = b.metadata || {};
                            
                            // If we have width/height metadata, use it
                            const aRatio = aData.width && aData.height ? aData.width / aData.height : 1;
                            const bRatio = bData.width && bData.height ? bData.width / bData.height : 1;
                            
                            // Group by general aspect ratio category
                            const aCategory = aRatio > 1.5 ? 'wide' : (aRatio < 0.7 ? 'tall' : 'square');
                            const bCategory = bRatio > 1.5 ? 'wide' : (bRatio < 0.7 ? 'tall' : 'square');
                            
                            // Alternate categories for better visual flow
                            if (aCategory !== bCategory) {
                                // Custom sort order: wide, square, tall, repeat
                                const order = { 'wide': 0, 'square': 1, 'tall': 2 };
                                return order[aCategory] - order[bCategory];
                            }
                            
                            return 0;
                        });
                    };
                    
                    // Optimize the layout
                    const optimizedData = optimizeImageLayout(data);
                    
                    // Process images in smaller batches with improved layout
                    const batchSize = 12; // Multiple of our 12-column grid
                    for (let i = 0; i < optimizedData.length; i += batchSize) {
                        const batch = optimizedData.slice(i, i + batchSize);
                        
                        // Process each batch
                        await Promise.all(batch.map(async (photo, batchIndex) => {
                            const index = i + batchIndex;
                            const imagePath = `photos/image_files/${photo.image_path}`;
                            const title = photo.image_title || 'Untitled';
                            const section = photo.section ? formatSectionId(photo.section) : null;
                            
                            const allItem = createGalleryItem(imagePath, title);
                            await addGalleryItemWithAnimation(allItem, index, document.getElementById('all-gallery'));
                            
                            if (section && sectionGalleries[section]) {
                                const sectionItem = createGalleryItem(imagePath, title);
                                await addGalleryItemWithAnimation(sectionItem, index, sectionGalleries[section]);
                            }
                        }));
                        
                        // Apply masonry layout after each batch
                        createMasonryLayout(document.getElementById('all-gallery'));
                        Object.values(sectionGalleries).forEach(gallery => {
                            createMasonryLayout(gallery);
                        });
                        
                        // Shorter pause between batches for better UX
                        if (i + batchSize < optimizedData.length) {
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                    }
                    
                    setupLightbox();
                    const observer = setupIntersectionObserver();
                    
                } catch (error) {
                    console.error('Error loading images:', error);
                    
                    const defaultSections = [
                        { id: 'black-and-white', name: 'Black & White' },
                        { id: 'plants', name: 'Plants & Nature' },
                        { id: 'microscopy', name: 'Microscopy' },
                        { id: 'portrait', name: 'Portraits' }
                    ];
                    
                    defaultSections.forEach(section => {
                        createSectionIfNeeded(section.id, section.name);
                    });
                    
                    const allPlaceholders = [
                        { size: '1600/900', title: 'Mountain Vista', section: 'plants' },
                        { size: '800/1200', title: 'Portrait Session', section: 'portrait' },
                        { size: '800/800', title: 'Cell Structure', section: 'microscopy' },
                        { size: '1600/900', title: 'Black and White Study', section: 'black-and-white' },
                        { size: '2000/1000', title: 'Panoramic View', section: 'plants' },
                        { size: '700/1400', title: 'Tall Structure', section: 'black-and-white' },
                        { size: '1200/800', title: 'Wide Angle Shot', section: 'plants' },
                        { size: '900/900', title: 'Square Composition', section: 'microscopy' }
                    ];
                    
                    allPlaceholders.forEach((item, index) => {
                        const allGalleryItem = createGalleryItem(
                            `/api/placeholder/${item.size}`, 
                            item.title
                        );
                        addGalleryItemWithAnimation(allGalleryItem, index, document.getElementById('all-gallery'));
                        
                        if (item.section && sectionGalleries[item.section]) {
                            const sectionItem = createGalleryItem(
                                `/api/placeholder/${item.size}`, 
                                item.title
                            );
                            addGalleryItemWithAnimation(sectionItem, index, sectionGalleries[item.section]);
                        }
                    });
                    
                    setTimeout(setupLightbox, 500);
                }
            };
            
            // Load once on page load
            loadPhotosFromJSON();
            
            // Optimize scroll handling - we don't want to lose visible images
            window.addEventListener('scroll', () => {
                // Throttle scroll events for better performance
                if (!window.scrollThrottleTimeout) {
                    window.scrollThrottleTimeout = setTimeout(() => {
                        // Get the active gallery section
                        const activeSection = document.querySelector('.gallery-section:not(.hidden)');
                        if (activeSection) {
                            preloadVisibleImages(activeSection.querySelector('.gallery'));
                        }
                        window.scrollThrottleTimeout = null;
                    }, 200);
                }
            }, { passive: true });
            
            setTimeout(showSiteContent, 1500);
        });
    </script>
</body>
</html>